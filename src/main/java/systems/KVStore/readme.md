## 设计一个键值数据库

## 需求
- put(key, value)
- get(key)
- 类似Amazon Dynamo，Memcached，Redis
- 键值对小于10K
- 支持大数据
- 高可用性，容忍节点故障
- 高扩展性，支持大规模数据集
- 自动扩容
- 可调整的一致性
- 低延迟

## 单机键值数据库
- 使用哈希表，保存在内存
- 或者磁盘，内容里只放热点数据

## 分布式键值数据库
- CAP 理论，一致性，可用性，分区容错性
- CA 系统不存在
- 数据分区
- 数据复制
- 一致性
- 解决冲突
- 容错
- 系统架构图
- 读写路径

## 数据分区
- 一致性哈希，虚拟节点
- 数据平均分布到每个节点
- 每次节点数量改变时，数据移动量最小
- 自动扩容，根据负载自动增减节点
- 异构，每个节点都应该一样，与整个系统的负载成正比

## 数据复制
- 可配置 N 个副本，顺时针方向上的N个后续节点
- 使用虚拟节点，可能分布在少于 N 个物理机器上
- 可以选择不同的 N 个物理机器

## 一致性
- N 副本数，W 写法定人数，W 读法定人数
- W + R > N，强一致性
- R = 1, W = N，快速读
- W = 1，R = N，快速写
- W + R <= N，不能保证强一致性

## 冲突解决，向量时钟
- [X: 1] -> [X: 2] --> [X: 2, Y: 1] ----> [X:2, Y:1, Z:1]
  \-> [X: 2, Z: 1] --/

## 故障检测
- 每个节点维护成员列表
- 每个节点周期性更新心跳
- 每个节点发送心跳给一组随机节点
- 其他节点收到心跳，就会更新成员列表
- 节点的心跳超时没更新，则会从成员列表删除
- TODO-Gossip

## 故障处理
- 带暗示的交接